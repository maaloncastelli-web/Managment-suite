<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { background-color: #f0f2f5; padding-top: 30px; font-family: sans-serif; }
      .container { max-width: 600px; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
      .loading { display: none; }
    </style>
  </head>
  <body>
    <div class="container">
      <h3 class="text-center mb-4 text-primary">Recepción de Pólizas</h3>
      
      <form id="policyForm" onsubmit="handleFormSubmit(this); return false;">
        
        <div class="mb-3">
          <label class="form-label">Comunidad</label>
          <select class="form-select" name="comunidad" required>
            <option value="" selected disabled>Seleccione...</option>
            <? for (var i = 0; i < comunidades.length; i++) { ?>
              <option value="<?= comunidades[i] ?>"><?= comunidades[i] ?></option>
            <? } ?>
          </select>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">N° Depto/Casa</label>
            <input type="text" class="form-control" name="depto" placeholder="Ej: 404-B" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Correo Electrónico</label>
            <input type="email" class="form-control" name="email" required>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Emisión</label>
            <input type="date" class="form-control" name="fechaEmision" required>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Expiración</label>
            <input type="date" class="form-control" name="fechaExpiracion" required>
          </div>
        </div>

        <div class="mb-4">
          <label class="form-label">Adjuntar Póliza (PDF)</label>
          <input type="file" class="form-control" name="pdfFile" accept="application/pdf" required>
        </div>

        <button type="submit" class="btn btn-primary w-100" id="submitBtn">Enviar Documento</button>
        
        <div class="text-center mt-4 loading" id="loadingSpinner">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2 text-muted">Subiendo archivo optimizado...</p>
        </div>

        <div id="messageBox" class="mt-3 alert" style="display:none;"></div>

      </form>
    </div>

    <script>
      function handleFormSubmit(formObject) {
        // UI Feedback inmediato
        const btn = document.getElementById('submitBtn');
        const spinner = document.getElementById('loadingSpinner');
        const msgBox = document.getElementById('messageBox');
        
        msgBox.style.display = 'none';
        btn.disabled = true;
        btn.innerText = "Enviando..."; // Feedback visual en el botón
        spinner.style.display = 'block';

        // Validar tamaño antes de enviar (Cliente)
        const fileInput = formObject.pdfFile;
        if (fileInput.files.length > 0 && fileInput.files[0].size > 25 * 1024 * 1024) {
           showError("El archivo excede los 25MB.");
           resetUI();
           return;
        }

        // Envío directo del objeto formulario (Mucho más rápido que FileReader)
        google.script.run
          .withSuccessHandler(function(response) {
            resetUI();
            if (response.success) {
              msgBox.className = 'alert alert-success';
              msgBox.innerText = response.message;
              msgBox.style.display = 'block';
              formObject.reset();
            } else {
              showError(response.message);
            }
          })
          .withFailureHandler(function(error) {
            resetUI();
            showError("Error de conexión: " + error.message);
          })
          .procesarFormulario(formObject);
      }

      function showError(msg) {
        const msgBox = document.getElementById('messageBox');
        msgBox.className = 'alert alert-danger';
        msgBox.innerText = msg;
        msgBox.style.display = 'block';
      }

      function resetUI() {
        const btn = document.getElementById('submitBtn');
        btn.disabled = false;
        btn.innerText = "Enviar Documento";
        document.getElementById('loadingSpinner').style.display = 'none';
      }
    </script>
  </body>
</html>